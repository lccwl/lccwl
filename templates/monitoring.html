{% extends "base.html" %}

{% block title %}Monitoring - AI Website Optimizer{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-3">
                <i data-feather="activity"></i>
                Performance Monitoring
            </h1>
            <p class="text-muted">Real-time website performance tracking and analysis</p>
        </div>
    </div>

    <!-- Monitoring Controls -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="settings"></i>
                        Monitoring Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="monitoringInterval" class="form-label">Monitoring Interval</label>
                            <select class="form-select" id="monitoringInterval">
                                <option value="5">Every 5 minutes</option>
                                <option value="15" selected>Every 15 minutes</option>
                                <option value="30">Every 30 minutes</option>
                                <option value="60">Every hour</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alertThreshold" class="form-label">Alert Threshold (Load Time)</label>
                            <input type="number" class="form-control" id="alertThreshold" value="3.0" step="0.1" min="0.5" max="10">
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="startMonitoring">
                            <i data-feather="play"></i> Start Monitoring
                        </button>
                        <button class="btn btn-secondary" id="stopMonitoring">
                            <i data-feather="pause"></i> Pause Monitoring
                        </button>
                        <button class="btn btn-success" id="runAnalysis">
                            <i data-feather="zap"></i> Run Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="alert-triangle"></i>
                        System Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Monitoring Status</span>
                        <span class="status-badge status-success">Active</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Last Check</span>
                        <span class="text-muted">2 mins ago</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Alerts Today</span>
                        <span class="badge bg-warning">3</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Data Points</span>
                        <span class="text-success">{{ monitoring_data|length }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="trending-up"></i>
                        Performance Metrics Over Time
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="detailedPerformanceChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="bar-chart"></i>
                        Performance Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="performanceDistribution" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Monitoring Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="database"></i>
                        Recent Monitoring Data
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="refreshData">
                            <i data-feather="refresh-cw"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="exportData">
                            <i data-feather="download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if monitoring_data %}
                        <div class="table-responsive">
                            <table class="table table-dark table-hover" id="monitoringTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>URL</th>
                                        <th>Load Time</th>
                                        <th>Memory Usage</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in monitoring_data %}
                                    <tr>
                                        <td>
                                            <div class="text-nowrap">{{ data.timestamp.strftime('%m/%d/%Y') }}</div>
                                            <small class="text-muted">{{ data.timestamp.strftime('%H:%M:%S') }}</small>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 200px;" title="{{ data.url }}">
                                                {{ data.url }}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="{% if data.load_time < 2 %}text-success{% elif data.load_time < 3 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ "%.2f"|format(data.load_time) }}s
                                            </span>
                                        </td>
                                        <td>
                                            <span class="{% if data.memory_usage < 50 %}text-success{% elif data.memory_usage < 100 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ "%.1f"|format(data.memory_usage) }}MB
                                            </span>
                                        </td>
                                        <td>
                                            {% if data.load_time < 2 and data.memory_usage < 50 %}
                                                <span class="status-badge status-success">Excellent</span>
                                            {% elif data.load_time < 3 and data.memory_usage < 100 %}
                                                <span class="status-badge status-warning">Good</span>
                                            {% else %}
                                                <span class="status-badge status-error">Needs Attention</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="analyzeEntry({{ data.id }})">
                                                    <i data-feather="search"></i>
                                                </button>
                                                <button class="btn btn-outline-info" onclick="viewDetails({{ data.id }})">
                                                    <i data-feather="eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i data-feather="bar-chart-2" class="text-muted" style="width: 64px; height: 64px;"></i>
                            <h5 class="mt-3 text-muted">No Monitoring Data Available</h5>
                            <p class="text-muted">Start monitoring to see performance data here</p>
                            <a href="{{ url_for('initialize_demo_data') }}" class="btn btn-primary">
                                <i data-feather="database"></i> Initialize Demo Data
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title">Performance Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Detailed Performance Chart
const detailedCtx = document.getElementById('detailedPerformanceChart').getContext('2d');
const detailedChart = new Chart(detailedCtx, {
    type: 'line',
    data: {
        labels: [
            {% for data in monitoring_data[-20:] %}
                '{{ data.timestamp.strftime("%H:%M") }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Load Time (s)',
            data: [
                {% for data in monitoring_data[-20:] %}
                    {{ data.load_time }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#165DFF',
            backgroundColor: 'rgba(22, 93, 255, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Memory Usage (MB)',
            data: [
                {% for data in monitoring_data[-20:] %}
                    {{ data.memory_usage }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#00F5D4',
            backgroundColor: 'rgba(0, 245, 212, 0.1)',
            tension: 0.4,
            fill: true,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#E2E8F0'
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#334155'
                },
                ticks: {
                    color: '#94A3B8'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                grid: {
                    color: '#334155'
                },
                ticks: {
                    color: '#94A3B8'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                    drawOnChartArea: false,
                },
                ticks: {
                    color: '#94A3B8'
                }
            }
        }
    }
});

// Performance Distribution Chart
const distributionCtx = document.getElementById('performanceDistribution').getContext('2d');
new Chart(distributionCtx, {
    type: 'bar',
    data: {
        labels: ['< 1s', '1-2s', '2-3s', '3-4s', '> 4s'],
        datasets: [{
            label: 'Page Count',
            data: [
                {% set counts = [0, 0, 0, 0, 0] %}
                {% for data in monitoring_data %}
                    {% if data.load_time < 1 %}
                        {% set _ = counts.__setitem__(0, counts[0] + 1) %}
                    {% elif data.load_time < 2 %}
                        {% set _ = counts.__setitem__(1, counts[1] + 1) %}
                    {% elif data.load_time < 3 %}
                        {% set _ = counts.__setitem__(2, counts[2] + 1) %}
                    {% elif data.load_time < 4 %}
                        {% set _ = counts.__setitem__(3, counts[3] + 1) %}
                    {% else %}
                        {% set _ = counts.__setitem__(4, counts[4] + 1) %}
                    {% endif %}
                {% endfor %}
                {{ counts[0] }}, {{ counts[1] }}, {{ counts[2] }}, {{ counts[3] }}, {{ counts[4] }}
            ],
            backgroundColor: [
                '#00F5D4',
                '#165DFF',
                '#7E22CE',
                '#F59E0B',
                '#EF4444'
            ],
            borderColor: [
                '#00F5D4',
                '#165DFF',
                '#7E22CE',
                '#F59E0B',
                '#EF4444'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#334155'
                },
                ticks: {
                    color: '#94A3B8'
                }
            },
            y: {
                grid: {
                    color: '#334155'
                },
                ticks: {
                    color: '#94A3B8'
                }
            }
        }
    }
});

// Event Listeners
document.getElementById('startMonitoring').addEventListener('click', function() {
    this.innerHTML = '<i data-feather="play"></i> Monitoring Active...';
    this.disabled = true;
    document.getElementById('stopMonitoring').disabled = false;
    feather.replace();
    
    // Show success message
    showAlert('Monitoring started successfully', 'success');
});

document.getElementById('stopMonitoring').addEventListener('click', function() {
    this.disabled = true;
    document.getElementById('startMonitoring').innerHTML = '<i data-feather="play"></i> Start Monitoring';
    document.getElementById('startMonitoring').disabled = false;
    feather.replace();
    
    showAlert('Monitoring paused', 'warning');
});

document.getElementById('runAnalysis').addEventListener('click', function() {
    const originalText = this.innerHTML;
    this.innerHTML = '<i data-feather="loader"></i> Analyzing...';
    this.disabled = true;
    feather.replace();
    
    // Simulate analysis
    setTimeout(() => {
        this.innerHTML = originalText;
        this.disabled = false;
        feather.replace();
        showAlert('Analysis completed successfully', 'success');
    }, 2000);
});

document.getElementById('refreshData').addEventListener('click', function() {
    location.reload();
});

document.getElementById('exportData').addEventListener('click', function() {
    showAlert('Export feature will be available soon', 'info');
});

// Helper functions
function analyzeEntry(id) {
    showAlert('AI analysis started for entry #' + id, 'info');
}

function viewDetails(id) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    document.getElementById('modalContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Performance Metrics</h6>
                <div class="metric-card mb-3">
                    <div class="metric-value">2.1s</div>
                    <div class="metric-label">Load Time</div>
                </div>
            </div>
            <div class="col-md-6">
                <h6>Memory Usage</h6>
                <div class="metric-card mb-3">
                    <div class="metric-value">45MB</div>
                    <div class="metric-label">Memory Used</div>
                </div>
            </div>
        </div>
        <h6>AI Recommendations</h6>
        <ul class="list-unstyled">
            <li class="mb-2"><i data-feather="check-circle" class="text-success me-2"></i> Optimize image compression</li>
            <li class="mb-2"><i data-feather="check-circle" class="text-success me-2"></i> Enable browser caching</li>
            <li class="mb-2"><i data-feather="alert-circle" class="text-warning me-2"></i> Minify CSS and JavaScript</li>
        </ul>
    `;
    modal.show();
    feather.replace();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Auto-refresh every 30 seconds
setInterval(() => {
    // Only refresh if monitoring is active
    if (!document.getElementById('startMonitoring').disabled) {
        // Update charts with new data
        fetch('/api/monitoring-data')
            .then(response => response.json())
            .then(data => {
                // Update chart data without full page reload
                console.log('Updated monitoring data');
            });
    }
}, 30000);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %}