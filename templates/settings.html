{% extends "base.html" %}

{% block title %}设置 - AI网站优化器{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-3">
                <i data-feather="settings"></i>
                插件设置
            </h1>
            <p class="text-muted">配置AI网站优化器的各项功能和参数</p>
        </div>
    </div>

    <!-- 设置标签页 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                                <i data-feather="key"></i> API设置
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">
                                <i data-feather="activity"></i> 监控设置
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="seo-tab" data-bs-toggle="tab" data-bs-target="#seo" type="button" role="tab">
                                <i data-feather="search"></i> SEO设置
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                                <i data-feather="shield"></i> 安全设置
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
                                <i data-feather="sliders"></i> 高级设置
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="settingsTabContent">
                        <!-- API设置 -->
                        <div class="tab-pane fade show active" id="api" role="tabpanel">
                            <form id="apiSettingsForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-4">
                                            <h5>Siliconflow API配置</h5>
                                            <p class="text-muted">配置您的Siliconflow API密钥以启用AI功能</p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="apiKey" class="form-label">API密钥 *</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxx">
                                                <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                                    <i data-feather="eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                获取API密钥：<a href="https://cloud.siliconflow.cn/" target="_blank">访问Siliconflow控制台</a>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="apiBaseUrl" class="form-label">API基础URL</label>
                                            <input type="url" class="form-control" id="apiBaseUrl" value="https://api.siliconflow.cn" readonly>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="defaultChatModel" class="form-label">默认聊天模型</label>
                                                <select class="form-select" id="defaultChatModel">
                                                    <option value="Qwen/QwQ-32B" selected>Qwen QwQ 32B</option>
                                                    <option value="Qwen/Qwen2.5-72B-Instruct">Qwen 2.5 72B Instruct</option>
                                                    <option value="meta-llama/Meta-Llama-3.1-8B-Instruct">Llama 3.1 8B Instruct</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="defaultImageModel" class="form-label">默认图片模型</label>
                                                <select class="form-select" id="defaultImageModel">
                                                    <option value="stabilityai/stable-diffusion-xl-base-1.0" selected>Stable Diffusion XL</option>
                                                    <option value="black-forest-labs/FLUX.1-schnell">FLUX.1 Schnell</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maxTokens" class="form-label">最大Token数</label>
                                                <input type="number" class="form-control" id="maxTokens" value="2000" min="100" max="32768">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="temperature" class="form-label">创意度 (Temperature)</label>
                                                <input type="range" class="form-range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                                                <div class="text-center"><span id="temperatureValue">0.7</span></div>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-success" id="testApiBtn">
                                                <i data-feather="zap"></i> 测试连接
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i data-feather="save"></i> 保存设置
                                            </button>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card" style="background: rgba(22, 93, 255, 0.05);">
                                            <div class="card-header">
                                                <h6 class="mb-0">API状态</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span>连接状态</span>
                                                    <span class="status-badge status-warning" id="connectionStatus">未测试</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span>今日调用</span>
                                                    <span class="text-success">45</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span>剩余配额</span>
                                                    <span class="text-info">9,955</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>账户余额</span>
                                                    <span class="text-success">$50.00</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mt-3" style="background: rgba(0, 245, 212, 0.05);">
                                            <div class="card-header">
                                                <h6 class="mb-0">可用模型</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-2">
                                                    <span class="badge bg-primary me-1">文本</span>
                                                    <small>3个模型</small>
                                                </div>
                                                <div class="mb-2">
                                                    <span class="badge bg-info me-1">图片</span>
                                                    <small>2个模型</small>
                                                </div>
                                                <div class="mb-2">
                                                    <span class="badge bg-warning me-1">视频</span>
                                                    <small>1个模型</small>
                                                </div>
                                                <div class="mb-2">
                                                    <span class="badge bg-success me-1">音频</span>
                                                    <small>2个模型</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- 监控设置 -->
                        <div class="tab-pane fade" id="monitoring" role="tabpanel">
                            <form id="monitoringSettingsForm">
                                <div class="mb-4">
                                    <h5>性能监控</h5>
                                    <p class="text-muted">配置网站性能监控参数</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableMonitoring" checked>
                                            <label class="form-check-label" for="enableMonitoring">
                                                启用性能监控
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="frontendMonitoring" checked>
                                            <label class="form-check-label" for="frontendMonitoring">
                                                前端性能跟踪
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="monitoringInterval" class="form-label">监控间隔</label>
                                        <select class="form-select" id="monitoringInterval">
                                            <option value="5">每5分钟</option>
                                            <option value="15" selected>每15分钟</option>
                                            <option value="30">每30分钟</option>
                                            <option value="60">每小时</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dataRetention" class="form-label">数据保留期</label>
                                        <select class="form-select" id="dataRetention">
                                            <option value="7">7天</option>
                                            <option value="30" selected>30天</option>
                                            <option value="90">90天</option>
                                            <option value="365">1年</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h6>警报阈值</h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="loadTimeThreshold" class="form-label">页面加载时间 (秒)</label>
                                            <input type="number" class="form-control" id="loadTimeThreshold" value="3.0" step="0.1" min="0.5">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="memoryThreshold" class="form-label">内存使用 (MB)</label>
                                            <input type="number" class="form-control" id="memoryThreshold" value="128" min="64">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="errorRateThreshold" class="form-label">错误率 (%)</label>
                                            <input type="number" class="form-control" id="errorRateThreshold" value="5" min="1" max="100">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>邮件通知</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="emailAlerts">
                                                <label class="form-check-label" for="emailAlerts">
                                                    启用邮件警报
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <input type="email" class="form-control" id="alertEmail" placeholder="admin@yoursite.com">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i data-feather="save"></i> 保存设置
                                </button>
                            </form>
                        </div>

                        <!-- SEO设置 -->
                        <div class="tab-pane fade" id="seo" role="tabpanel">
                            <form id="seoSettingsForm">
                                <div class="mb-4">
                                    <h5>SEO优化</h5>
                                    <p class="text-muted">配置搜索引擎优化功能</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoSeoOptimization" checked>
                                            <label class="form-check-label" for="autoSeoOptimization">
                                                自动SEO优化
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="seoBackup" checked>
                                            <label class="form-check-label" for="seoBackup">
                                                优化前备份
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="targetKeywords" class="form-label">目标关键词</label>
                                    <textarea class="form-control" id="targetKeywords" rows="3" placeholder="网站优化, SEO, WordPress插件"></textarea>
                                    <div class="form-text">每行一个关键词，或用逗号分隔</div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="seoAnalysisFreq" class="form-label">分析频率</label>
                                        <select class="form-select" id="seoAnalysisFreq">
                                            <option value="daily">每日</option>
                                            <option value="weekly" selected>每周</option>
                                            <option value="monthly">每月</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="contentOptimization" class="form-label">内容优化级别</label>
                                        <select class="form-select" id="contentOptimization">
                                            <option value="conservative">保守</option>
                                            <option value="balanced" selected>平衡</option>
                                            <option value="aggressive">积极</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h6>自动优化选项</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoMetaDescription" checked>
                                                <label class="form-check-label" for="autoMetaDescription">
                                                    自动生成Meta描述
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoImageAlt" checked>
                                                <label class="form-check-label" for="autoImageAlt">
                                                    自动生成图片Alt文本
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoInternalLinks" checked>
                                                <label class="form-check-label" for="autoInternalLinks">
                                                    自动添加内部链接
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoSchema" checked>
                                                <label class="form-check-label" for="autoSchema">
                                                    自动添加结构化数据
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoSitemap">
                                                <label class="form-check-label" for="autoSitemap">
                                                    自动更新站点地图
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoRobots">
                                                <label class="form-check-label" for="autoRobots">
                                                    自动优化Robots.txt
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i data-feather="save"></i> 保存设置
                                </button>
                            </form>
                        </div>

                        <!-- 安全设置 -->
                        <div class="tab-pane fade" id="security" role="tabpanel">
                            <form id="securitySettingsForm">
                                <div class="mb-4">
                                    <h5>安全配置</h5>
                                    <p class="text-muted">配置插件安全功能</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableSecurity" checked>
                                            <label class="form-check-label" for="enableSecurity">
                                                启用安全监控
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableRateLimit" checked>
                                            <label class="form-check-label" for="enableRateLimit">
                                                启用API请求限制
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="rateLimitRequests" class="form-label">请求限制 (每分钟)</label>
                                        <input type="number" class="form-control" id="rateLimitRequests" value="60" min="10" max="1000">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="sessionTimeout" class="form-label">会话超时 (分钟)</label>
                                        <input type="number" class="form-control" id="sessionTimeout" value="30" min="5" max="480">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h6>访问控制</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="restrictToAdmins" checked>
                                                <label class="form-check-label" for="restrictToAdmins">
                                                    仅管理员访问
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="logUserActions" checked>
                                                <label class="form-check-label" for="logUserActions">
                                                    记录用户操作
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="encryptApiKeys" checked>
                                                <label class="form-check-label" for="encryptApiKeys">
                                                    加密存储API密钥
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="enableAuditLog" checked>
                                                <label class="form-check-label" for="enableAuditLog">
                                                    启用审计日志
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="allowedIps" class="form-label">允许的IP地址 (可选)</label>
                                    <textarea class="form-control" id="allowedIps" rows="3" placeholder="192.168.1.1&#10;10.0.0.0/8"></textarea>
                                    <div class="form-text">每行一个IP地址或CIDR块，留空允许所有IP</div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i data-feather="save"></i> 保存设置
                                </button>
                            </form>
                        </div>

                        <!-- 高级设置 -->
                        <div class="tab-pane fade" id="advanced" role="tabpanel">
                            <form id="advancedSettingsForm">
                                <div class="mb-4">
                                    <h5>高级配置</h5>
                                    <p class="text-muted">高级用户选项和调试功能</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="debugMode">
                                            <label class="form-check-label" for="debugMode">
                                                启用调试模式
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableCaching" checked>
                                            <label class="form-check-label" for="enableCaching">
                                                启用缓存
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="cacheExpiry" class="form-label">缓存过期时间 (小时)</label>
                                        <input type="number" class="form-control" id="cacheExpiry" value="24" min="1" max="168">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="maxFileSize" class="form-label">最大文件大小 (MB)</label>
                                        <input type="number" class="form-control" id="maxFileSize" value="10" min="1" max="100">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h6>数据库优化</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoCleanup" checked>
                                                <label class="form-check-label" for="autoCleanup">
                                                    自动清理过期数据
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="optimizeTables">
                                                <label class="form-check-label" for="optimizeTables">
                                                    定期优化数据表
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="enableIndexes" checked>
                                                <label class="form-check-label" for="enableIndexes">
                                                    启用数据库索引
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="compressData">
                                                <label class="form-check-label" for="compressData">
                                                    压缩存储数据
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="customCss" class="form-label">自定义CSS</label>
                                    <textarea class="form-control" id="customCss" rows="6" placeholder="/* 在这里添加自定义CSS样式 */"></textarea>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-feather="save"></i> 保存设置
                                    </button>
                                    <button type="button" class="btn btn-warning" id="resetSettings">
                                        <i data-feather="refresh-cw"></i> 重置为默认
                                    </button>
                                    <button type="button" class="btn btn-success" id="exportSettings">
                                        <i data-feather="download"></i> 导出设置
                                    </button>
                                    <button type="button" class="btn btn-info" id="importSettings">
                                        <i data-feather="upload"></i> 导入设置
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统信息 -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="info"></i>
                        系统信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <small class="text-muted">插件版本</small>
                            <div>v1.0.0</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">WordPress版本</small>
                            <div>6.4.2</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">PHP版本</small>
                            <div>8.1.0</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">数据库版本</small>
                            <div>MySQL 8.0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="hard-drive"></i>
                        存储使用情况
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small>数据库大小</small>
                            <small class="text-muted">15.2MB</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: 15%; background: var(--primary-color);"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small>缓存文件</small>
                            <small class="text-muted">8.7MB</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: 8%; background: var(--secondary-color);"></div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-outline-warning">
                            <i data-feather="trash-2"></i> 清理缓存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 导入设置模态框 -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title">导入设置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="settingsFile" class="form-label">选择设置文件</label>
                    <input type="file" class="form-control" id="settingsFile" accept=".json">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="overwriteSettings">
                    <label class="form-check-label" for="overwriteSettings">
                        覆盖现有设置
                    </label>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmImport">导入</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Temperature滑块值显示
document.getElementById('temperature').addEventListener('input', function() {
    document.getElementById('temperatureValue').textContent = this.value;
});

// API密钥显示/隐藏
document.getElementById('toggleApiKey').addEventListener('click', function() {
    const input = document.getElementById('apiKey');
    const icon = this.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-feather', 'eye-off');
    } else {
        input.type = 'password';
        icon.setAttribute('data-feather', 'eye');
    }
    feather.replace();
});

// 测试API连接
document.getElementById('testApiBtn').addEventListener('click', function() {
    const btn = this;
    const originalText = btn.innerHTML;
    const statusElement = document.getElementById('connectionStatus');
    
    btn.innerHTML = '<i data-feather="loader"></i> 测试中...';
    btn.disabled = true;
    statusElement.textContent = '测试中...';
    statusElement.className = 'status-badge status-warning';
    
    fetch('/api/test-api', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            api_key: document.getElementById('apiKey').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusElement.textContent = '连接成功';
            statusElement.className = 'status-badge status-success';
            showAlert('API连接测试成功！', 'success');
        } else {
            statusElement.textContent = '连接失败';
            statusElement.className = 'status-badge status-error';
            showAlert('API连接失败，请检查密钥是否正确', 'error');
        }
    })
    .catch(error => {
        statusElement.textContent = '连接错误';
        statusElement.className = 'status-badge status-error';
        showAlert('测试过程中发生错误：' + error.message, 'error');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        feather.replace();
    });
});

// 表单提交处理
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formName = this.id.replace('Form', '');
        showAlert(`${formName}设置已保存`, 'success');
    });
});

// 重置设置
document.getElementById('resetSettings').addEventListener('click', function() {
    if (confirm('确定要重置为默认设置吗？此操作不可撤销。')) {
        showAlert('设置已重置为默认值', 'info');
    }
});

// 导出设置
document.getElementById('exportSettings').addEventListener('click', function() {
    const settings = {
        api: {
            key: '***',
            baseUrl: document.getElementById('apiBaseUrl').value,
            defaultChatModel: document.getElementById('defaultChatModel').value,
            defaultImageModel: document.getElementById('defaultImageModel').value
        },
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai-optimizer-settings.json';
    a.click();
    URL.revokeObjectURL(url);
    
    showAlert('设置已导出', 'success');
});

// 导入设置
document.getElementById('importSettings').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
});

document.getElementById('confirmImport').addEventListener('click', function() {
    const fileInput = document.getElementById('settingsFile');
    
    if (fileInput.files.length === 0) {
        showAlert('请选择设置文件', 'warning');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const settings = JSON.parse(e.target.result);
            showAlert('设置导入成功', 'success');
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
        } catch (error) {
            showAlert('设置文件格式错误', 'error');
        }
    };
    
    reader.readAsText(file);
});

// 显示提示信息
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %}